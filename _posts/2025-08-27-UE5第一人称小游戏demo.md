---
title: UE5第一人称小游戏demo
date: 2025-08-27 18:00:00 +0800
categories: [项目工作]
tags: [UE5]
---

## 展示
使用C++与蓝图结合实现FPS游戏的基础功能，包括玩家角色的行走/奔跑状态及对应动画（1D 混合空间）切换、武器拾取、切换、射击、换弹和消耗品使用。基于GAS实现玩家与敌人角色的属性管理及HUD显示逻辑：包含敌人受击后的生命值动态变化、玩家技能释放时的生命与能量消耗、能量恢复及呼吸回血机制。通过动态多播委托实现能量在一段时间未消耗后自动恢复，以及拾取武器后自动更新弹药HUD。

{%
    include embed/video.html
    src='/assets/ue/uecpp_fps_demo.mp4'
    poster='/assets/ue/uecpp_fps_demo.png'
    title='uecpp fps demo'
    autoplay=false
    loop=false
    muted=false
%}

## 实现
### GAS部分
#### ASC
首先创建一个继承自`AbilitySystemComponent`类的ASC类
```CPP
#include "CoreMinimal.h"
#include "AbilitySystemComponent.h"
#include "AdventureAbilitySystemComponent.generated.h"

UCLASS()
class MYADVENTURE_API UAdventureAbilitySystemComponent : public UAbilitySystemComponent
{
	GENERATED_BODY()
	
};
```
#### Player AttributeSet定义
|Health|MaxHealth|Energy|MaxEnergy|Damage|Cost|Breath|
|:---|:---|:---|:---|:---|:---|:---|
|血量|血量上限|能量|能量上限|技能伤害|能量消耗|呼吸恢复|
```CPP
DECLARE_DYNAMIC_MULTICAST_DELEGATE_ThreeParams(FCharacterAttributeChangedEvent, UAttributeSet*, AttributeSet, float, OldValue, float, NewValue);

UCLASS()
class MYADVENTURE_API UAdventureCharacterAttributeSet : public UAttributeSet
{
	GENERATED_BODY()

public:
	UAdventureCharacterAttributeSet();

	virtual void PreAttributeChange(const FGameplayAttribute& Attribute, float& NewValue) override;

	virtual void PostAttributeChange(const FGameplayAttribute& Attribute, float OldValue, float NewValue) override;

	virtual void PostGameplayEffectExecute(const struct FGameplayEffectModCallbackData& Data) override;

	// meta: 不允许 GE 直接修改 Health
	UPROPERTY(VisibleAnywhere, BlueprintReadOnly, meta = (HideFromModifiers))
	FGameplayAttributeData Health;

	UPROPERTY(VisibleAnywhere, BlueprintReadOnly)
	FGameplayAttributeData MaxHealth;

	UPROPERTY(VisibleAnywhere, BlueprintReadOnly, meta = (HideFromModifiers))
	FGameplayAttributeData Energy;

	UPROPERTY(VisibleAnywhere, BlueprintReadOnly)
	FGameplayAttributeData MaxEnergy;

	UPROPERTY(BlueprintAssignable)
	FCharacterAttributeChangedEvent OnAttributeChanged;

	UPROPERTY(VisibleAnywhere)
	FGameplayAttributeData Damage;

	UPROPERTY(VisibleAnywhere)
	FGameplayAttributeData Cost;

	UPROPERTY(VisibleAnywhere)
	FGameplayAttributeData Breath;

	ATTRIBUTE_ACCESSORS_BASIC(UAdventureCharacterAttributeSet, Health);
	ATTRIBUTE_ACCESSORS_BASIC(UAdventureCharacterAttributeSet, MaxHealth);
	ATTRIBUTE_ACCESSORS_BASIC(UAdventureCharacterAttributeSet, Energy);
	ATTRIBUTE_ACCESSORS_BASIC(UAdventureCharacterAttributeSet, MaxEnergy);
	ATTRIBUTE_ACCESSORS_BASIC(UAdventureCharacterAttributeSet, Damage);
	ATTRIBUTE_ACCESSORS_BASIC(UAdventureCharacterAttributeSet, Cost);
	ATTRIBUTE_ACCESSORS_BASIC(UAdventureCharacterAttributeSet, Breath);
}; // Enemy AttributeSet只有Health
```
#### Class Player定义
```CPP
DECLARE_DYNAMIC_MULTICAST_DELEGATE(FOnToolEquipped);

UCLASS()
class MYADVENTURE_API AAdventureCharacter : public ACharacter, public IAbilitySystemInterface
{
	// ...
public:
	AAdventureCharacter();

	void OnEnergyChanged(const FOnAttributeChangeData& Data);

	void CheckBreathRegenCondition();

	UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = AbilitySystemComponent)
	TObjectPtr<UAdventureAbilitySystemComponent> AdventureAbilitySystemComponent;

	UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = AbilitySystemComponent)
	TObjectPtr<UAdventureCharacterAttributeSet> AdventureCharacterAttributeSet;

	UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = Projectile)
	int RifleProjectilesStorage = 0; // 弹药库存

	UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Breath")
	bool bBreathTriggered = false; // 开启呼吸恢复，确保蓝图能访问到

	UPROPERTY(BlueprintAssignable)
	FOnToolEquipped OnToolEquipped; // 拾取武器事件，触发显示弹药HUD

	FTimerHandle BreathCheckTimerHandle;

	float LastEnergyDecreaseTime = -FLT_MAX;
};

AAdventureCharacter::AAdventureCharacter()
{
	// ...

	AdventureAbilitySystemComponent = CreateDefaultSubobject<UAdventureAbilitySystemComponent>(TEXT("AdventureAbilitySystemComponent"));
	AdventureCharacterAttributeSet = CreateDefaultSubobject<UAdventureCharacterAttributeSet>(TEXT("AdventureCharacterAttributeSet"));

	// 绑定能量变化，Energy 一变化就调用 OnEnergyChanged
	AdventureAbilitySystemComponent->GetGameplayAttributeValueChangeDelegate(AdventureCharacterAttributeSet->GetEnergyAttribute()).AddUObject(this, &AAdventureCharacter::OnEnergyChanged);
}

void AAdventureCharacter::BeginPlay()
{
	// ...

	if (AdventureAbilitySystemComponent != nullptr) {
		AdventureAbilitySystemComponent->InitAbilityActorInfo(this, this);

		GetWorld()->GetTimerManager().SetTimer(BreathCheckTimerHandle, this, &AAdventureCharacter::CheckBreathRegenCondition, 0.2f, true); // 每隔0.2s检查一次
	}
}

UAdventureAbilitySystemComponent* AAdventureCharacter::GetAbilitySystemComponent() const {
	return AdventureAbilitySystemComponent;
}
```

##### 玩家属性恢复实现
一定时间内某属性没有减少，就开始自动恢复（cod呼吸回血、塞尔达恢复能量）
```CPP
void AAdventureCharacter::OnEnergyChanged(const FOnAttributeChangeData & Data)
{
	// 记录下最后能量减少的时间戳
	if (Data.NewValue < Data.OldValue) {
		LastEnergyDecreaseTime = GetWorld()->GetTimeSeconds();
		bBreathTriggered = false;
	}
}

void AAdventureCharacter::CheckBreathRegenCondition()
{
	// 每隔0.2s检查一次，是否距离上一次能量减少过去了3s，如果是就设置flag，蓝图中继续调用恢复的 Gameplay Effect
	float Now = GetWorld()->GetTimeSeconds();
	if (!bBreathTriggered && (Now - LastEnergyDecreaseTime >= 3.f)) {
		bBreathTriggered = true;
	}
}
```

使用 SetTimerByFunctionName 达到循环执行某个函数
![HUD的蓝图部分](/assets/ue/HUD.png)
![GE 呼吸恢复能量](/assets/ue/Breath.png)
![GE 奔跑消耗能量](/assets/ue/CostWhenRunning.png)